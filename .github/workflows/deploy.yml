name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
  # major.minor ë²„ì „ì€ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ì—¬ í•„ìš”í•  ë•Œ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½
  MAJOR_VERSION: 1
  MINOR_VERSION: 0

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # í˜„ì¬ íŒ¨ì¹˜ ë²„ì „ ê°€ì ¸ì˜¤ê¸°
      - name: Get current version
        id: version
        run: |
          # í˜„ì¬ íŒ¨ì¹˜ ë²„ì „ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì‹œì‘)
          CURRENT_PATCH=$(curl -s http://localhost:5000/v2/chat-backend/tags/list | jq -r '.tags[]' | grep "^${MAJOR_VERSION}.${MINOR_VERSION}." | sort -V | tail -n1 | cut -d. -f3 || echo "0")
          NEW_PATCH=$((CURRENT_PATCH + 1))
          echo "version=${MAJOR_VERSION}.${MINOR_VERSION}.${NEW_PATCH}" >> $GITHUB_OUTPUT

      # ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Backend Image
        id: build-backend
        run: |
          cd backend
          docker build -t localhost:5000/chat-backend:${{ steps.version.outputs.version }} .
          docker push localhost:5000/chat-backend:${{ steps.version.outputs.version }}

      - name: Build and Push Frontend Image
        id: build-frontend
        run: |
          cd frontend
          docker build -t localhost:5000/chat-frontend:${{ steps.version.outputs.version }} .
          docker push localhost:5000/chat-frontend:${{ steps.version.outputs.version }}
      
      - name: Notify Image Build Status
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ—ï¸ ì´ë¯¸ì§€ ë¹Œë“œ ìƒíƒœ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ì´ë¯¸ì§€ ë¹Œë“œ ê²°ê³¼*\n- ë²„ì „: ${{ steps.version.outputs.version }}\n- Backend: ${{ steps.build-backend.outcome }}\n- Frontend: ${{ steps.build-frontend.outcome }}"
                  }
                }
              ]
            }

      # Stage 1: Registry ë°°í¬
      - name: Deploy Registry
        id: deploy-registry
        run: |
          cd terraform/stage1-registry
          terraform init
          terraform apply -auto-approve
      
      - name: Notify Registry Deployment
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸš€ Registry ë°°í¬ ì™„ë£Œ"
            }

      # Stage 2: ê¸°ë³¸ ì¸í”„ë¼ ë°°í¬
      - name: Deploy Infrastructure
        id: deploy-infra
        run: |
          cd terraform/stage2-infra
          terraform init
          terraform apply -auto-approve
      
      - name: Notify Infrastructure Deployment Status
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ—ï¸ ì¸í”„ë¼ ë°°í¬ ìƒíƒœ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ì¸í”„ë¼ ë°°í¬ ${{ steps.deploy-infra.outcome }}*\n${{ steps.deploy-infra.outcome == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }}

      # Stage 3: ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
      - name: Deploy Applications
        id: deploy-apps
        run: |
          cd terraform/stage3-apps
          terraform init
          terraform apply -auto-approve
      
      - name: Notify Applications Deployment Status
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ“± ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ìƒíƒœ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ${{ steps.deploy-apps.outcome }}*\n${{ steps.deploy-apps.outcome == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }}

      # ìµœì¢… ë°°í¬ ìƒíƒœ ì•Œë¦¼
      - name: Final Deployment Status
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ‰ ì „ì²´ ë°°í¬ ì™„ë£Œ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë°°í¬ ìµœì¢… ìƒíƒœ*\n- Registry: ${{ steps.deploy-registry.outcome }}\n- ì¸í”„ë¼: ${{ steps.deploy-infra.outcome }}\n- ì• í”Œë¦¬ì¼€ì´ì…˜: ${{ steps.deploy-apps.outcome }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }} 